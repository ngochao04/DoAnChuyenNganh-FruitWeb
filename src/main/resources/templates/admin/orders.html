<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" dir="ltr"
      data-theme="theme-default" data-assets-path="../assets/"
      data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Đơn hàng | Admin</title>
  <meta name="description" content="" />

  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>

  <style>
    #orderTable td.actions,
    #orderTable th.actions {
      white-space: nowrap;
      width: 1%;
    }

    #orderTable td.actions .btn {
      display: inline-flex;
      align-items: center;
    }
  </style>
</head>

<body>
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    <!-- Sidebar -->
    <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
      <div class="app-brand demo">
        <a href="/admin" class="app-brand-link">
          <span class="app-brand-logo demo">
            <svg width="25" viewBox="0 0 25 42" xmlns="http://www.w3.org/2000/svg">
              <g fill="#696cff">
                <path
                    d="M13.79.36 3.4 7.44c-2.83 2.25-3.78 5.03-2.84 8.35.13.43.53 1.98 2.57 3.42.7.49 2.21 1.15 4.55 1.99l-4.96 3.31c-2.19 1.75-2.55 3.95-1.08 6.62 1.27 1.64 3.64 2.08 5.52 1.35 1.26-.48 4.37-2.53 9.33-6.17 1.62-1.87 2.29-3.91 2-6.13-.45-2.7-2.24-4.66-5.37-5.86l-2.13-.9 7.7-5.49L13.79.36z" />
              </g>
            </svg>
          </span>
          <span class="app-brand-text demo menu-text fw-bolder ms-2">Admin</span>
        </a>

        <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
          <i class="bx bx-chevron-left bx-sm align-middle"></i>
        </a>
      </div>

      <div class="menu-inner-shadow"></div>

      <ul class="menu-inner py-1">
        <li class="menu-item">
          <a href="/admin" class="menu-link">
            <i class="menu-icon tf-icons bx bx-home-circle"></i>
            <div>Dashboard</div>
          </a>
        </li>

        <li class="menu-header small text-uppercase">
          <span class="menu-header-text">Quản lý</span>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/categories">
            <i class="menu-icon tf-icons bx bx-purchase-tag"></i>
            <div>Danh mục</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/products">
            <i class="menu-icon tf-icons bx bx-cube"></i>
            <div>Sản phẩm</div>
          </a>
        </li>

        <li class="menu-item active">
          <a class="menu-link" href="/admin/orders">
            <i class="menu-icon tf-icons bx bx-receipt"></i>
            <div>Đơn hàng</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/customers">
            <i class="menu-icon tf-icons bx bx-user"></i>
            <div>Khách hàng</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/inventory">
            <i class="menu-icon tf-icons bx bx-store"></i>
            <div>Kho</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/promotions">
            <i class="menu-icon tf-icons bx bx-gift"></i>
            <div>Khuyến mãi</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/reports">
            <i class="menu-icon tf-icons bx bx-bar-chart"></i>
            <div>Báo cáo</div>
          </a>
        </li>

        <li class="menu-header small text-uppercase">
          <span class="menu-header-text">Hệ thống</span>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/settings">
            <i class="menu-icon tf-icons bx bx-cog"></i>
            <div>Cấu hình</div>
          </a>
        </li>
      </ul>
    </aside>
    <!-- /Sidebar -->

    <div class="layout-page">
      <!-- Navbar -->
      <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
           id="layout-navbar">
        <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
          <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
            <i class="bx bx-menu bx-sm"></i>
          </a>
        </div>

        <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
          <div class="navbar-nav align-items-center">
            <div class="nav-item d-flex align-items-center">
              <i class="bx bx-search fs-4 lh-0"></i>
              <input type="text" id="navSearch" class="form-control border-0 shadow-none"
                     placeholder="Tìm theo mã đơn, tên, phone..." />
            </div>
          </div>

          <ul class="navbar-nav flex-row align-items-center ms-auto">
            <li class="nav-item navbar-dropdown dropdown-user dropdown">
              <a class="nav-link dropdown-toggle hide-arrow" href="#" data-bs-toggle="dropdown">
                <div class="avatar avatar-online">
                  <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                </div>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#">
                    <i class="bx bx-user me-2"></i>
                    <span>Hồ sơ</span>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                    <i class="bx bx-cog me-2"></i>
                    <span>Cài đặt</span>
                  </a>
                </li>
                <li><div class="dropdown-divider"></div></li>
                <li>
                  <a class="dropdown-item" href="auth-login-basic.html">
                    <i class="bx bx-power-off me-2"></i>
                    <span>Đăng xuất</span>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <!-- /Navbar -->

      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">

          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
            <h4 class="fw-bold mb-1">Quản lý Đơn hàng</h4>
          </div>

          <div class="row">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <h5 class="mb-0">Danh sách đơn hàng</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div class="input-group w-auto">
                      <span class="input-group-text"><i class="bx bx-search"></i></span>
                      <input type="text" id="searchInput" class="form-control"
                             placeholder="Tìm theo mã đơn, tên, phone..." />
                    </div>
                  </div>
                </div>

                <div class="table-responsive text-nowrap">
                  <table class="table mb-0" id="orderTable">
                    <thead>
                    <tr>
                      <th style="width:50px">#</th>
                      <th style="width:130px">Phone</th>
                      <th style="min-width:160px">Tên KH</th>
                      <th class="text-end" style="width:130px">Tiền hàng</th>
                      <th class="text-end" style="width:130px">Giảm giá</th>
                      <th class="text-end" style="width:150px">Tổng thanh toán</th>
                      <th style="width:150px">Trạng thái</th>
                      <th style="width:170px">Thanh toán</th>
                      <th style="width:190px">Cập nhật</th>
                      <th class="text-end actions" style="width:80px">Hành động</th>
                    </tr>
                    </thead>
                    <tbody class="table-border-bottom-0" id="orderBody"></tbody>
                  </table>
                </div>

                <div
                    class="card-footer d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
                  <div id="pageInfo" class="text-muted small">Đang tải…</div>
                  <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="btnPrev">
                      <i class="bx bx-chevron-left"></i> Trước
                    </button>
                    <span id="pageCurrent" class="small"></span>
                    <button class="btn btn-sm btn-outline-secondary" id="btnNext">
                      Sau <i class="bx bx-chevron-right"></i>
                    </button>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>

        <footer class="content-footer footer bg-footer-theme">
          <div class="container-xxl d-flex justify-content-between py-2 flex-md-row flex-column">
            <div>© <script>document.write(new Date().getFullYear())</script> - Admin</div>
          </div>
        </footer>
      </div>
    </div>
  </div>
</div>

<!-- ================= MODAL CHI TIẾT ĐƠN HÀNG ================= -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Chi tiết đơn hàng <span id="modalOrderNo" class="text-muted fs-6"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <!-- Cột trái -->
          <div class="col-lg-4 mb-3">
            <div class="mb-4">
              <h6 class="text-muted mb-2">Khách hàng</h6>
              <p class="mb-2"><strong>Tên:</strong> <span id="modalRecipientName">...</span></p>
              <p class="mb-2"><strong>Phone:</strong> <span id="modalPhone">...</span></p>
              <p class="mb-0">
                <strong>Địa chỉ:</strong><br>
                <span id="modalAddressLine1"></span><br>
                <span id="modalWard"></span>,
                <span id="modalDistrict"></span>,
                <span id="modalProvince"></span>
              </p>
            </div>

            <div class="mb-4">
              <h6 class="text-muted mb-2">Trạng thái</h6>
              <p class="mb-2">
                <strong>Đơn hàng:</strong><br>
                <span id="modalStatusLabel" class="badge bg-label-primary rounded-pill">...</span>
              </p>
              <p class="mb-2">
                <strong>Thanh toán:</strong><br>
                <span id="modalPaymentMethodLabel"
                      class="badge bg-label-secondary rounded-pill">...</span>
              </p>
              <p class="mb-0">
                <strong>Trạng thái thanh toán:</strong><br>
                <span id="modalPaymentStatusLabel"
                      class="badge bg-label-warning rounded-pill">...</span>
              </p>
            </div>

            <div>
              <h6 class="text-muted mb-2">Tổng tiền</h6>
              <p class="mb-2">
                <span>Tiền hàng:</span>
                <span class="float-end" id="modalItemsTotal">0</span>
              </p>
              <p class="mb-2">
                <span>Giảm giá:</span>
                <span class="float-end" id="modalDiscountTotal">0</span>
              </p>
              <p class="mb-2">
                <span>Phí vận chuyển:</span>
                <span class="float-end" id="modalShippingFee">0</span>
              </p>
              <hr>
              <p class="mb-0 fw-bold">
                <span>Tổng thanh toán:</span>
                <span class="float-end" id="modalGrandTotal">0</span>
              </p>
            </div>
          </div>

          <!-- Cột phải -->
          <div class="col-lg-8 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="text-muted mb-0">Sản phẩm trong đơn</h6>
              <small class="text-muted">Cập nhật: <span id="modalUpdatedAt">...</span></small>
            </div>
            <div class="table-responsive text-nowrap">
              <table class="table table-sm mb-0">
                <thead>
                <tr>
                  <th style="width:40px">#</th>
                  <th>Sản phẩm</th>
                  <th class="text-end" style="width:70px">SL</th>
                  <th class="text-end" style="width:120px">Đơn giá</th>
                  <th class="text-end" style="width:120px">Giảm</th>
                  <th class="text-end" style="width:140px">Thành tiền</th>
                </tr>
                </thead>
                <tbody id="modalItemBody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <small class="text-muted me-auto">
          Tạo lúc: <span id="modalCreatedAt">...</span>
        </small>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
<!-- ================= /MODAL ================= -->

<!-- Scripts -->
<script src="../assets/vendor/libs/jquery/jquery.js"></script>
<script src="../assets/vendor/libs/popper/popper.js"></script>
<script src="../assets/vendor/js/bootstrap.js"></script>
<script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
<script src="../assets/vendor/js/menu.js"></script>

<script>
(() => {
  const API = '/api/admin/orders';

  const body = document.getElementById('orderBody');
  const searchInput = document.getElementById('searchInput');
  const navSearch   = document.getElementById('navSearch');
  const pageInfo    = document.getElementById('pageInfo');
  const pageCurrent = document.getElementById('pageCurrent');
  const btnPrev     = document.getElementById('btnPrev');
  const btnNext     = document.getElementById('btnNext');

  const state = { page: 0, size: 10, q: '' };

  const fmtVnd = (n) => (n == null) ? '0'
    : new Intl.NumberFormat('vi-VN').format(n);

  const esc = (s) => (s ?? '').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');

  function whenUpdated(o){
    if (!o.updatedAt) return '-';
    try { return new Date(o.updatedAt).toLocaleString('vi-VN'); }
    catch { return o.updatedAt; }
  }

  function badgeStatus(o){
    const text = o.statusLabel || o.status || '-';
    return `<span class="badge bg-label-primary rounded-pill">${esc(text)}</span>`;
  }

  function badgePayment(o){
    const method = o.paymentMethodLabel || o.paymentMethod || '';
    const status = o.paymentStatusLabel || o.paymentStatus || '';
    return `
      <div class="d-flex flex-column gap-1">
        <span class="badge bg-label-secondary rounded-pill">${esc(method)}</span>
        <span class="badge bg-label-warning rounded-pill">${esc(status)}</span>
      </div>`;
  }

  async function load(){
    const url = `${API}?page=${state.page}&size=${state.size}`
      + (state.q ? `&q=${encodeURIComponent(state.q)}` : '');

    const res = await fetch(url);
    if (!res.ok){
      body.innerHTML =
        '<tr><td colspan="10" class="text-center text-danger py-3">Không tải được dữ liệu</td></tr>';
      pageInfo.textContent = 'Lỗi tải dữ liệu';
      pageCurrent.textContent = '';
      return;
    }

    const pg = await res.json();   // <-- KHÔNG JSON.parse thủ công

    body.innerHTML = '';

    if (!pg.content || !pg.content.length){
      body.innerHTML =
        '<tr><td colspan="10" class="text-center text-muted py-4">Không có dữ liệu</td></tr>';
    } else {
      pg.content.forEach((o,i) => {
        const idx = pg.pageable.pageNumber * pg.size + i + 1;
        body.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${idx}</td>
            <td>${esc(o.phone || '')}</td>
            <td>${esc(o.recipientName || '')}</td>
            <td class="text-end">${fmtVnd(o.itemsTotal)}</td>
            <td class="text-end">${fmtVnd(o.discountTotal)}</td>
            <td class="text-end">${fmtVnd(o.grandTotal)}</td>
            <td>${badgeStatus(o)}</td>
            <td>${badgePayment(o)}</td>
            <td>${whenUpdated(o)}</td>
            <td class="text-end actions">
              <button type="button"
                      class="btn btn-sm btn-outline-secondary btn-view-order"
                      data-id="${o.id}" title="Xem chi tiết">
                <i class="bx bx-show"></i>
              </button>
            </td>
          </tr>
        `);
      });
    }

    const from = pg.totalElements ? (pg.pageable.pageNumber * pg.size + 1) : 0;
    const to   = pg.pageable.pageNumber * pg.size + pg.numberOfElements;
    pageInfo.textContent =
      `Hiển thị ${from}-${to} / ${pg.totalElements}`;
    pageCurrent.textContent =
      `Trang ${pg.pageable.pageNumber + 1}/${Math.max(pg.totalPages,1)}`;

    btnPrev.disabled = (pg.pageable.pageNumber <= 0);
    btnNext.disabled = (pg.pageable.pageNumber >= (pg.totalPages - 1));
  }

  // search
  let debounce;
  function triggerSearch(term){
    clearTimeout(debounce);
    debounce = setTimeout(() => {
      state.q = (term || '').trim();
      state.page = 0;
      if (searchInput && searchInput.value !== term) searchInput.value = term;
      if (navSearch && navSearch.value !== term)   navSearch.value   = term;
      load();
    }, 300);
  }

  searchInput?.addEventListener('input', () => triggerSearch(searchInput.value));
  navSearch?.addEventListener('input',   () => triggerSearch(navSearch.value));

  btnPrev.addEventListener('click', () => {
    if (state.page > 0){
      state.page--;
      load();
    }
  });

  btnNext.addEventListener('click', () => {
    state.page++;
    load();
  });

  // ===== MODAL CHI TIẾT =====
  async function openOrderModal(id){
    try{
      const res = await fetch(`${API}/${id}`);
      if (!res.ok){
        alert('Không tải được chi tiết đơn hàng');
        return;
      }

      const o = await res.json();   // <-- CHỈ dùng res.json()

      document.getElementById('modalOrderNo').textContent =
        o.orderNo ? `#${o.orderNo}` : `#${o.id}`;

      document.getElementById('modalRecipientName').textContent = o.recipientName ?? '-';
      document.getElementById('modalPhone').textContent         = o.phone ?? '-';
      document.getElementById('modalAddressLine1').textContent  = o.addressLine1 ?? '';
      document.getElementById('modalWard').textContent          = o.ward ?? '';
      document.getElementById('modalDistrict').textContent      = o.district ?? '';
      document.getElementById('modalProvince').textContent      = o.province ?? '';

      document.getElementById('modalStatusLabel').textContent =
        o.statusLabel ?? o.status ?? '-';
      document.getElementById('modalPaymentMethodLabel').textContent =
        o.paymentMethodLabel ?? o.paymentMethod ?? '-';
      document.getElementById('modalPaymentStatusLabel').textContent =
        o.paymentStatusLabel ?? o.paymentStatus ?? '-';

      document.getElementById('modalItemsTotal').textContent    = fmtVnd(o.itemsTotal);
      document.getElementById('modalDiscountTotal').textContent = fmtVnd(o.discountTotal);
      document.getElementById('modalShippingFee').textContent   = fmtVnd(o.shippingFee);
      document.getElementById('modalGrandTotal').textContent    = fmtVnd(o.grandTotal);

      if (o.createdAt){
        document.getElementById('modalCreatedAt').textContent =
          new Date(o.createdAt).toLocaleString('vi-VN');
      } else document.getElementById('modalCreatedAt').textContent = '-';

      if (o.updatedAt){
        document.getElementById('modalUpdatedAt').textContent =
          new Date(o.updatedAt).toLocaleString('vi-VN');
      } else document.getElementById('modalUpdatedAt').textContent = '-';

      const itemBody = document.getElementById('modalItemBody');
      itemBody.innerHTML = '';
      if (!o.items || !o.items.length){
        itemBody.innerHTML =
          '<tr><td colspan="6" class="text-center text-muted py-3">Không có sản phẩm trong đơn</td></tr>';
      } else {
        o.items.forEach((it, idx) => {
          itemBody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${idx + 1}</td>
              <td>${esc(it.titleSnapshot ?? '')}</td>
              <td class="text-end">${it.quantity ?? 0}</td>
              <td class="text-end">${fmtVnd(it.unitPrice)}</td>
              <td class="text-end">${fmtVnd(it.discount)}</td>
              <td class="text-end">${fmtVnd(it.lineTotal)}</td>
            </tr>
          `);
        });
      }

      const modalEl = document.getElementById('orderDetailModal');
      const modal   = new bootstrap.Modal(modalEl);
      modal.show();

    } catch (e){
      console.error('Lỗi khi tải chi tiết đơn hàng', e);
      alert('Lỗi khi tải chi tiết đơn hàng');
    }
  }

  // click nút xem
  body.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-view-order');
    if (!btn) return;
    const id = btn.dataset.id;
    if (id) openOrderModal(id);
  });

  // ✅ THÊM FUNCTION NÀY
async function updateOrderStatus(orderId, newStatus) {
    const statusLabels = {
        'CONFIRMED': 'Xác nhận',
        'SHIPPED': 'Đã gửi hàng',
        'COMPLETED': 'Hoàn thành',
        'CANCELLED': 'Hủy'
    };
    
    const action = statusLabels[newStatus] || newStatus;
    
    if (!confirm(`Bạn có chắc muốn ${action.toLowerCase()} đơn hàng này?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/orders/${orderId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update status');
        }
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message || 'Đã cập nhật trạng thái');
            load(); // Reload danh sách
        } else {
            alert(result.message || 'Không thể cập nhật trạng thái');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Lỗi khi cập nhật trạng thái');
    }
}
  // init
  load();
})();
</script>

<script src="../assets/js/main.js"></script>
</body>
</html>
