<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" dir="ltr"
      data-theme="theme-default" data-assets-path="../assets/"
      data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Khách hàng | Admin</title>
  <meta name="description" content="" />

  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>

  <style>
    #customerTable td.actions,
    #customerTable th.actions {
      white-space: nowrap;
      width: 1%;
    }

    #customerTable td.actions .btn {
      display: inline-flex;
      align-items: center;
    }
  </style>
</head>

<body>
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    <!-- Sidebar -->
    <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
      <div class="app-brand demo">
        <a href="/admin" class="app-brand-link">
          <span class="app-brand-logo demo">
            <svg width="25" viewBox="0 0 25 42" xmlns="http://www.w3.org/2000/svg">
              <g fill="#696cff">
                <path
                    d="M13.79.36 3.4 7.44c-2.83 2.25-3.78 5.03-2.84 8.35.13.43.53 1.98 2.57 3.42.7.49 2.21 1.15 4.55 1.99l-4.96 3.31c-2.19 1.75-2.55 3.95-1.08 6.62 1.27 1.64 3.64 2.08 5.52 1.35 1.26-.48 4.37-2.53 9.33-6.17 1.62-1.87 2.29-3.91 2-6.13-.45-2.7-2.24-4.66-5.37-5.86l-2.13-.9 7.7-5.49L13.79.36z" />
              </g>
            </svg>
          </span>
          <span class="app-brand-text demo menu-text fw-bolder ms-2">Admin</span>
        </a>

        <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
          <i class="bx bx-chevron-left bx-sm align-middle"></i>
        </a>
      </div>

      <div class="menu-inner-shadow"></div>

      <ul class="menu-inner py-1">
        <li class="menu-item">
          <a href="/admin" class="menu-link">
            <i class="menu-icon tf-icons bx bx-home-circle"></i>
            <div>Dashboard</div>
          </a>
        </li>

        <li class="menu-header small text-uppercase">
          <span class="menu-header-text">Quản lý</span>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/categories">
            <i class="menu-icon tf-icons bx bx-purchase-tag"></i>
            <div>Danh mục</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/products">
            <i class="menu-icon tf-icons bx bx-cube"></i>
            <div>Sản phẩm</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/orders">
            <i class="menu-icon tf-icons bx bx-receipt"></i>
            <div>Đơn hàng</div>
          </a>
        </li>

        <li class="menu-item active">
          <a class="menu-link" href="/admin/customers">
            <i class="menu-icon tf-icons bx bx-user"></i>
            <div>Khách hàng</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/inventory">
            <i class="menu-icon tf-icons bx bx-store"></i>
            <div>Kho</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/promotions">
            <i class="menu-icon tf-icons bx bx-gift"></i>
            <div>Khuyến mãi</div>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/reports">
            <i class="menu-icon tf-icons bx bx-bar-chart"></i>
            <div>Báo cáo</div>
          </a>
        </li>

        <li class="menu-header small text-uppercase">
          <span class="menu-header-text">Hệ thống</span>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/settings">
            <i class="menu-icon tf-icons bx bx-cog"></i>
            <div>Cấu hình</div>
          </a>
        </li>
      </ul>
    </aside>
    <!-- /Sidebar -->

    <div class="layout-page">
      <!-- Navbar -->
      <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
           id="layout-navbar">
        <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
          <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
            <i class="bx bx-menu bx-sm"></i>
          </a>
        </div>

        <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
          <div class="navbar-nav align-items-center">
            <div class="nav-item d-flex align-items-center">
              <i class="bx bx-search fs-4 lh-0"></i>
              <input type="text" id="navSearch" class="form-control border-0 shadow-none"
                     placeholder="Tìm theo tên, email, phone..." />
            </div>
          </div>

          <ul class="navbar-nav flex-row align-items-center ms-auto">
            <li class="nav-item navbar-dropdown dropdown-user dropdown">
              <a class="nav-link dropdown-toggle hide-arrow" href="#" data-bs-toggle="dropdown">
                <div class="avatar avatar-online">
                  <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                </div>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#">
                    <i class="bx bx-user me-2"></i>
                    <span>Hồ sơ</span>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">
                    <i class="bx bx-cog me-2"></i>
                    <span>Cài đặt</span>
                  </a>
                </li>
                <li><div class="dropdown-divider"></div></li>
                <li>
                  <a class="dropdown-item" href="auth-login-basic.html">
                    <i class="bx bx-power-off me-2"></i>
                    <span>Đăng xuất</span>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <!-- /Navbar -->

      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">

          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
            <h4 class="fw-bold mb-1">Quản lý Khách hàng</h4>
          </div>

          <div class="row">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <h5 class="mb-0">Danh sách khách hàng</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div class="input-group w-auto">
                      <span class="input-group-text"><i class="bx bx-search"></i></span>
                      <input type="text" id="searchInput" class="form-control"
                             placeholder="Tìm theo tên, email, phone..." />
                    </div>
                  </div>
                </div>

                <div class="table-responsive text-nowrap">
                  <table class="table mb-0" id="customerTable">
                    <thead>
                    <tr>
                      <th style="width:50px">#</th>
                      <th style="min-width:180px">Họ tên</th>
                      <th style="min-width:200px">Email</th>
                      <th style="width:130px">Phone</th>
                      <th class="text-center" style="width:100px">Địa chỉ</th>
                      <th class="text-center" style="width:120px">Email XN</th>
                      <th style="width:120px">Trạng thái</th>
                      <th style="width:180px">Tham gia</th>
                      <th class="text-end actions" style="width:160px">Hành động</th>
                    </tr>
                    </thead>
                    <tbody class="table-border-bottom-0" id="customerBody"></tbody>
                  </table>
                </div>

                <div
                    class="card-footer d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
                  <div id="pageInfo" class="text-muted small">Đang tải…</div>
                  <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="btnPrev">
                      <i class="bx bx-chevron-left"></i> Trước
                    </button>
                    <span id="pageCurrent" class="small"></span>
                    <button class="btn btn-sm btn-outline-secondary" id="btnNext">
                      Sau <i class="bx bx-chevron-right"></i>
                    </button>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>

        <footer class="content-footer footer bg-footer-theme">
          <div class="container-xxl d-flex justify-content-between py-2 flex-md-row flex-column">
            <div>© <script>document.write(new Date().getFullYear())</script> - Admin</div>
          </div>
        </footer>
      </div>
    </div>
  </div>
</div>

<!-- ================= MODAL CHI TIẾT KHÁCH HÀNG ================= -->
<div class="modal fade" id="customerDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Chi tiết khách hàng <span id="modalCustomerName" class="text-muted fs-6"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <!-- Cột trái: Thông tin khách hàng -->
          <div class="col-lg-4 mb-3">
            <div class="mb-4">
              <h6 class="text-muted mb-3">Thông tin cá nhân</h6>
              <p class="mb-2"><strong>Họ tên:</strong> <span id="modalFullName">...</span></p>
              <p class="mb-2"><strong>Email:</strong> <span id="modalEmail">...</span></p>
              <p class="mb-2"><strong>Phone:</strong> <span id="modalPhone">...</span></p>
            </div>

            <div class="mb-4">
              <h6 class="text-muted mb-3">Trạng thái tài khoản</h6>
              <p class="mb-2">
                <strong>Kích hoạt:</strong>
                <span id="modalIsActive" class="badge bg-label-success rounded-pill">...</span>
              </p>
              <p class="mb-0">
                <strong>Email xác nhận:</strong>
                <span id="modalEmailVerified" class="badge bg-label-info rounded-pill">...</span>
              </p>
            </div>

            <div>
              <h6 class="text-muted mb-3">Thời gian</h6>
              <p class="mb-2">
                <strong>Tham gia:</strong><br>
                <span id="modalCreatedAt">...</span>
              </p>
              <p class="mb-0">
                <strong>Cập nhật:</strong><br>
                <span id="modalUpdatedAt">...</span>
              </p>
            </div>
          </div>

          <!-- Cột phải: Danh sách địa chỉ -->
          <div class="col-lg-8 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-muted mb-0">Địa chỉ giao hàng</h6>
              <span class="badge bg-label-secondary" id="addressCountBadge">0 địa chỉ</span>
            </div>

            <div id="addressList">
              <!-- Address cards will be inserted here -->
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
<!-- ================= /MODAL ================= -->

<!-- Scripts -->
<script src="../assets/vendor/libs/jquery/jquery.js"></script>
<script src="../assets/vendor/libs/popper/popper.js"></script>
<script src="../assets/vendor/js/bootstrap.js"></script>
<script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
<script src="../assets/vendor/js/menu.js"></script>

<script>
(() => {
  const API = '/api/admin/customers';

  const body = document.getElementById('customerBody');
  const searchInput = document.getElementById('searchInput');
  const navSearch   = document.getElementById('navSearch');
  const pageInfo    = document.getElementById('pageInfo');
  const pageCurrent = document.getElementById('pageCurrent');
  const btnPrev     = document.getElementById('btnPrev');
  const btnNext     = document.getElementById('btnNext');

  const state = { page: 0, size: 10, q: '' };

  const esc = (s) => (s ?? '').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');

  function formatDate(d){
    if (!d) return '-';
    try { return new Date(d).toLocaleString('vi-VN'); }
    catch { return d; }
  }

  function badgeStatus(isActive){
    return isActive
      ? '<span class="badge bg-label-success rounded-pill">KÍCH HOẠT</span>'
      : '<span class="badge bg-label-warning rounded-pill">VÔ HIỆU</span>';
  }

  function badgeEmailVerified(verified){
    return verified
      ? '<span class="badge bg-label-success rounded-pill"><i class="bx bx-check"></i></span>'
      : '<span class="badge bg-label-secondary rounded-pill"><i class="bx bx-x"></i></span>';
  }

  async function load(){
    const url = `${API}?page=${state.page}&size=${state.size}`
      + (state.q ? `&q=${encodeURIComponent(state.q)}` : '');

    const res = await fetch(url);
    if (!res.ok){
      body.innerHTML =
        '<tr><td colspan="9" class="text-center text-danger py-3">Không tải được dữ liệu</td></tr>';
      pageInfo.textContent = 'Lỗi tải dữ liệu';
      pageCurrent.textContent = '';
      return;
    }

    const pg = await res.json();

    body.innerHTML = '';

    if (!pg.content || !pg.content.length){
      body.innerHTML =
        '<tr><td colspan="9" class="text-center text-muted py-4">Không có dữ liệu</td></tr>';
    } else {
      pg.content.forEach((u,i) => {
        const idx = pg.pageable.pageNumber * pg.size + i + 1;
        body.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${idx}</td>
            <td><strong>${esc(u.fullName || '')}</strong></td>
            <td>${esc(u.email || '')}</td>
            <td>${esc(u.phone || '-')}</td>
            <td class="text-center">
              <span class="badge bg-label-info rounded-pill">${u.addressCount || 0}</span>
            </td>
            <td class="text-center">${badgeEmailVerified(u.emailVerified)}</td>
            <td>${badgeStatus(u.isActive)}</td>
            <td>${formatDate(u.createdAt)}</td>
            <td class="text-end actions">
              <button type="button"
                      class="btn btn-sm btn-outline-primary btn-view-customer"
                      data-id="${u.id}" title="Xem chi tiết">
                <i class="bx bx-show"></i>
              </button>
              <button type="button"
                      class="btn btn-sm ${u.isActive ? 'btn-outline-warning' : 'btn-outline-success'} btn-toggle-status"
                      data-id="${u.id}" 
                      data-active="${u.isActive}"
                      title="${u.isActive ? 'Vô hiệu hóa' : 'Kích hoạt'}">
                <i class="bx ${u.isActive ? 'bx-lock' : 'bx-lock-open'}"></i>
              </button>
            </td>
          </tr>
        `);
      });
    }

    const from = pg.totalElements ? (pg.pageable.pageNumber * pg.size + 1) : 0;
    const to   = pg.pageable.pageNumber * pg.size + pg.numberOfElements;
    pageInfo.textContent =
      `Hiển thị ${from}-${to} / ${pg.totalElements}`;
    pageCurrent.textContent =
      `Trang ${pg.pageable.pageNumber + 1}/${Math.max(pg.totalPages,1)}`;

    btnPrev.disabled = (pg.pageable.pageNumber <= 0);
    btnNext.disabled = (pg.pageable.pageNumber >= (pg.totalPages - 1));
  }

  // search
  let debounce;
  function triggerSearch(term){
    clearTimeout(debounce);
    debounce = setTimeout(() => {
      state.q = (term || '').trim();
      state.page = 0;
      if (searchInput && searchInput.value !== term) searchInput.value = term;
      if (navSearch && navSearch.value !== term)   navSearch.value   = term;
      load();
    }, 300);
  }

  searchInput?.addEventListener('input', () => triggerSearch(searchInput.value));
  navSearch?.addEventListener('input',   () => triggerSearch(navSearch.value));

  btnPrev.addEventListener('click', () => {
    if (state.page > 0){
      state.page--;
      load();
    }
  });

  btnNext.addEventListener('click', () => {
    state.page++;
    load();
  });

  // ===== MODAL CHI TIẾT =====
  async function openCustomerModal(id){
    try{
      const res = await fetch(`${API}/${id}`);
      if (!res.ok){
        alert('Không tải được chi tiết khách hàng');
        return;
      }

      const u = await res.json();

      document.getElementById('modalCustomerName').textContent = u.fullName || '';
      document.getElementById('modalFullName').textContent = u.fullName || '-';
      document.getElementById('modalEmail').textContent = u.email || '-';
      document.getElementById('modalPhone').textContent = u.phone || '-';

      const activeEl = document.getElementById('modalIsActive');
      activeEl.textContent = u.isActive ? 'Đang hoạt động' : 'Vô hiệu hóa';
      activeEl.className = u.isActive 
        ? 'badge bg-label-success rounded-pill' 
        : 'badge bg-label-warning rounded-pill';

      const verifiedEl = document.getElementById('modalEmailVerified');
      verifiedEl.textContent = u.emailVerified ? 'Đã xác nhận' : 'Chưa xác nhận';
      verifiedEl.className = u.emailVerified 
        ? 'badge bg-label-success rounded-pill' 
        : 'badge bg-label-secondary rounded-pill';

      document.getElementById('modalCreatedAt').textContent = formatDate(u.createdAt);
      document.getElementById('modalUpdatedAt').textContent = formatDate(u.updatedAt);

      // Render addresses
      const addressList = document.getElementById('addressList');
      const addressCount = document.getElementById('addressCountBadge');
      
      addressCount.textContent = `${u.addresses?.length || 0} địa chỉ`;

      if (!u.addresses || !u.addresses.length){
        addressList.innerHTML = '<div class="alert alert-info mb-0">Chưa có địa chỉ giao hàng</div>';
      } else {
        addressList.innerHTML = '';
        u.addresses.forEach((addr, idx) => {
          const isDefault = addr.isDefault 
            ? '<span class="badge bg-label-primary ms-2">Mặc định</span>' 
            : '';
          
          addressList.insertAdjacentHTML('beforeend', `
            <div class="card mb-2">
              <div class="card-body">
                <h6 class="card-title mb-2">
                  Địa chỉ ${idx + 1} ${isDefault}
                </h6>
                <p class="mb-1"><strong>Người nhận:</strong> ${esc(addr.recipientName || '-')}</p>
                <p class="mb-1"><strong>Phone:</strong> ${esc(addr.phone || '-')}</p>
                <p class="mb-1"><strong>Địa chỉ:</strong> ${esc(addr.line1 || '-')}</p>
                <p class="mb-1">
                  <strong>Khu vực:</strong> 
                  ${esc(addr.ward || '')}, ${esc(addr.district || '')}, ${esc(addr.province || '')}
                </p>
                ${addr.note ? `<p class="mb-0"><strong>Ghi chú:</strong> ${esc(addr.note)}</p>` : ''}
              </div>
            </div>
          `);
        });
      }

      const modalEl = document.getElementById('customerDetailModal');
      const modal   = new bootstrap.Modal(modalEl);
      modal.show();

    } catch (e){
      console.error('Lỗi khi tải chi tiết khách hàng', e);
      alert('Lỗi khi tải chi tiết khách hàng');
    }
  }

  // ===== TOGGLE STATUS =====
  async function toggleStatus(id, currentActive){
    const newActive = !currentActive;
    const confirmMsg = newActive 
      ? 'Kích hoạt tài khoản khách hàng này?' 
      : 'Vô hiệu hóa tài khoản khách hàng này?';
    
    if (!confirm(confirmMsg)) return;

    try {
      const res = await fetch(`${API}/${id}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isActive: newActive })
      });

      if (!res.ok) throw new Error('Failed to update status');

      const result = await res.json();
      alert(result.message || 'Đã cập nhật trạng thái');
      load();
    } catch (e) {
      console.error('Lỗi khi cập nhật trạng thái', e);
      alert('Không thể cập nhật trạng thái');
    }
  }

  // click actions
  body.addEventListener('click', (e) => {
    const viewBtn = e.target.closest('.btn-view-customer');
    if (viewBtn) {
      const id = viewBtn.dataset.id;
      if (id) openCustomerModal(id);
      return;
    }

    const toggleBtn = e.target.closest('.btn-toggle-status');
    if (toggleBtn) {
      const id = toggleBtn.dataset.id;
      const active = toggleBtn.dataset.active === 'true';
      if (id) toggleStatus(id, active);
      return;
    }
  });

  // init
  load();
})();
</script>

<script src="../assets/js/main.js"></script>
</body>
</html>